# docker-compose.yml – Rural Health-Camp Logistics Agent
# ════════════════════════════════════════════════════════════════════════════
# One-command startup:
#   docker-compose up --build
#
# Services
# ────────
#   app      – Streamlit UI  + OR-Tools backend  + ML pipeline  (port 8501)
#   watcher  – lightweight file-watcher for hot-reload in dev mode (optional)
#
# Volumes
# ────────
#   ./data    → persists CSV uploads and generated history between restarts
#   ./models  → persists trained joblib model so it isn't re-trained every run
# ════════════════════════════════════════════════════════════════════════════

version: "3.9"

services:

  # ── Main application ───────────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: rural-health-agent:latest
    container_name: rural_health_app

    ports:
      - "8501:8501"       # Host:Container – open http://localhost:8501

    environment:
      # ── App config ─────────────────────────────────────────────────────────
      - STREAMLIT_SERVER_MAX_UPLOAD_SIZE=50   # MB; raise if uploading large CSVs
      - LOG_LEVEL=INFO

      # ── API Keys (use a .env file in production – never hard-code!) ────────
      # Create a .env file in the same directory with:
      #   OWM_API_KEY=your_key_here
      - OWM_API_KEY=${OWM_API_KEY:-}          # defaults to "" → mock mode

    volumes:
      # Persist data and trained models across container restarts
      - ./data:/app/data
      - ./models:/app/models

      # DEV ONLY: mount source so code changes reflect without rebuild
      # Comment these out for a production image build
      - ./app.py:/app/app.py:ro
      - ./hour4_data_model.py:/app/hour4_data_model.py:ro
      - ./hour5_vrp_solver.py:/app/hour5_vrp_solver.py:ro
      - ./hour11_live_environment.py:/app/hour11_live_environment.py:ro
      - ./hour12_predictive_ml.py:/app/hour12_predictive_ml.py:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    restart: unless-stopped

    networks:
      - healthnet

  # ── (Optional) Nginx reverse-proxy ────────────────────────────────────────
  # Uncomment the block below when deploying to a cloud VM (AWS EC2 / Azure VM)
  # to serve Streamlit on port 80 with proper headers.
  #
  # nginx:
  #   image: nginx:1.25-alpine
  #   container_name: rural_health_nginx
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
  #   depends_on:
  #     app:
  #       condition: service_healthy
  #   networks:
  #     - healthnet
  #   restart: unless-stopped

networks:
  healthnet:
    driver: bridge
